---
name: Pull Request
on:
  workflow_dispatch:
  pull_request:
    branches: [main]
jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: 3.x
      - run: python -m pip install pre-commit
        shell: bash
      - run: python -m pip freeze --local
        shell: bash
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-3|${{ env.pythonLocation }}|${{ hashFiles('.pre-commit-config.yaml') }}
      - run: pre-commit run --show-diff-on-failure --color=always ${{ inputs.extra_args }}
        shell: bash

  diff:
    strategy:
      matrix:
        charts:
          - type: pub
            name: app
    runs-on: ubuntu-latest
    needs: [pre-commit]
    steps:
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Source Template
        run: |
          helm dependency build ./charts/${{ matrix.charts.type }}/${{ matrix.charts.name }}.test
          helm template ./charts/${{ matrix.charts.type }}/${{ matrix.charts.name }}.test | tee ${{ matrix.charts.name }}.${{ matrix.charts.type }}.source.k8s.yaml

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.charts.name }}-${{ matrix.charts.type }}-source-k8s
          path: ${{ matrix.charts.name }}.${{ matrix.charts.type }}.source.k8s.yaml

      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.charts.name }}-${{ matrix.charts.type }}-source-k8s

      - name: Target Template
        run: |
          helm dependency build ./charts/${{ matrix.charts.type }}/${{ matrix.charts.name }}.test
          helm template ./charts/${{ matrix.charts.type }}/${{ matrix.charts.name }}.test | tee ${{ matrix.charts.name }}.${{ matrix.charts.type }}.target.k8s.yaml

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v13

      - name: Enable Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v7

      - name: Install difftastic
        run: |
          nix-env --install difftastic --file '<nixpkgs>'

      - name: Diff
        run: |
          difft ${{ matrix.charts.name }}.${{ matrix.charts.type }}.source.k8s.yaml ${{ matrix.charts.name }}.${{ matrix.charts.type }}.target.k8s.yaml | tee ${{ matrix.charts.name }}.${{ matrix.charts.type }}.diff.txt

      - name: Report
        uses: andreswebs/gh-actions/.github/actions/file-report@main
        with:
          source-txt-file: ${{ matrix.charts.name }}.${{ matrix.charts.type }}.diff.txt
          environment: ${{ matrix.charts.name }}.${{ matrix.charts.type }}
